<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@taglib prefix="c" uri="http://java.sun.com/jstl/core_rt"%>
<%@taglib prefix="fmt" uri="http://java.sun.com/jstl/fmt_rt"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="EUC-KR">
<title>${movie.title}의자세한 정보!</title>
<!-- 1월 22일 11:48분 최종 수정함 -->
<link rel="stylesheet" href="/resources/CSS/detail.css" type="text/css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
section {
	max-width: 1320px;
	margin-left: 110px;
	margin-right: 110px;
	display: block;
}

ul {
	list-style: none;
	display: flex;
	align-items: center;
	margin: 0;
	padding: 0;
	margin-top: 0;
	margin-bottom: 0;
	margin-left: 0;
	margin-right: 0;
}

.search {
	margin: 0 0 0 auto;
}

.top_a {
	height: 40px;
	padding-right: 16px;
	display: flex; 
	align-items: center;
}

.modal {
	position: fixed;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	z-index: 20;
	display: none;
}

.bg {
	position: fixed;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	background: #71717142
}

.box {
	position: absolute;
	z-index: 21;
	background: #ffff;
	border-radius: 5px;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	margin: auto;
	width: fit-content;
	height: fit-content;
	padding: 50px;
}

.box h5 {
	font-size: 20px;
	text-align: center;
	margin-bottom: 20px;
}

.box p {
	text-align: center;
}

.box input {
	display: block;
	margin: 20px 0;
}

.is-show {
	display: block !important;
}

/* 전체 배우 정보 컨테이너 */
.actor-info {
    padding: 20px;
}

.actor-header {
    text-align: center;
    font-size: 24px;
    margin-bottom: 20px;
}

.swiper {
    width: 100%;
    height: auto;
}

.swiper-wrapper {
    display: flex;
    flex-wrap: wrap;
}

.swiper-slide {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-basis: 25%; /* 4 items per row (adjust as needed) */
    box-sizing: border-box;
    padding: 10px;
}

.actor-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4 columns per slide */
    gap: 20px;
    width: 100%;
}

.actor-entry {
    text-align: center;
}

.actor-image {
    width: 100px;
    height: 150px;
    object-fit: cover;
    border-radius: 5px;
}

.actor-name, .actor-gender, .actor-character {
    font-size: 14px;
    margin: 5px 0;
}

.swiper-button-next, .swiper-button-prev {
    color: #000;
}

.swiper-pagination {
    bottom: 10px;
    text-align: center;
}


</style>

</head>
<body>
	<header id="header">
		<!-- 로그인 모달 -->
		<div class="modal login">
			<div class="bg"></div>
			<div class="box">
				<form action="/login" method="POST">
					<p>아이디 입력하게</p>
					<input class="login_input" type="text" name="uid" />
					<p>비밀번호 입력하게</p>
					<input class="login_input" type="password" name="upw" />
					<button class="menubtn" type="submit">로그인</button>
				</form>
				<a href="/userform"><button class="menubtn">회원가입 들어갈곳</button></a> <a
					href="/">아이디를 잊으셨나요</a><a href="/">비밀번호를 잊으셨나요?</a>
			</div>
		</div>
		<div class="modal ID">
			<div class="bg"></div>
			<div class="box">
				<p>이메일을 입력하세요</p>
				<input  class="login_input" type="text" />
				<p>전화번호를 입력하세요</p>
				<input class="login_input" type="text" />
				<button class="menubtn">확인</button>
			</div>
		</div>
		<div class="modal pw">
			<div class="bg"></div>
			<div class="box">
				<p>이메일을 입력하세요</p>
				<input class="login_input" type="text" />
				<!-- 여기에 이제 컨트롤러에서 이메일 중복 확인, 확인이 되면 
         send-email로 이메일에 인증번호를 보낼 수 있도록 할 것임. -->
				<button class="menubtn">확인</button>
			</div>
		</div>
		<nav>
			<section>
				<ul class="menu_bar">
					<li class="logo">
						<a href="/" type="button">
							<img id="logoimg" class="logoimg" src="resources/IMG/moviepedia_33.png">
						</a>
					</li>
					<li class="board"><a type="button"><span>게시판</span></a></li>
					<li class="search">
                   		<form action="/search?=" method="get">
                       		<input type="text" name="word" placeholder="영화감독, 제목, 배우를 검색해보세요">
                   		</form>
               		</li>
					<li class="login">
						<button class="loginbtn" id="loginbtn">
							<c:set var="loginId"
								value="${sessionScope eq null ? '' : sessionScope.usaveprofile }" />
							<c:set var="loginOut"
								value="${loginId eq null ? '로그인' : '로그아웃'  }" />
							<c:out value="${loginOut}" />
						</button>
					</li>
					<li class="profile"><c:if
							test="${not empty sessionScope.usaveprofile}">
							<a href="userupdate" type="button"> <img
								src="${sessionScope.usaveprofile  }" alt="프로필 사진"
								style="width: 50px; height: 50px; border-radius: 50%;">
							</a>
						</c:if> <c:if test="${empty sessionScope.usaveprofile}">
							<!-- 프로필 사진이 없을 경우 기본 이미지 -->
							<a href="userupdate" type="button"> <img class="userimg"
								src="${pageContext.request.contextPath}/resources/UPLOAD/Default.jpg"
								alt="기본 프로필 사진" />
							</a>
						</c:if></li>

				</ul>
			</section>
		</nav>
	</header>

	<div class="bodylayout">
		<div class="movie_top_box">
			<div class="movie_back">
			    <c:choose>
	     		    <c:when test="${not empty movie.backdrop_path and movie.backdrop_path ne 'https://image.tmdb.org/t/p/original/null'}">
						<img class="backimg" src="https://image.tmdb.org/t/p/original${movie.backdrop_path}" alt="${movie.title}" />
		      		</c:when>
		        <c:otherwise>
		            <img src="${pageContext.request.contextPath}/resources/IMG/default2.jpg" alt="포스터의 사진이 제공되지 않는 작품입니다." />
		        </c:otherwise>
		 	   </c:choose>
			</div>
			<div class="movie_container">
				<div class="movie_info">
					<h1>${movie.title }</h1>
					<div class="movie_title">${movie.original_title }</div>
					<div class="movie_releasedate">${movie.release_date }</div>
					<div class="movie_ganreids">
						<c:forEach items="${movie.genrename}" var="genreName"
							varStatus="status">
        	                    ${genreName}${!status.last ? ', ' : ''}
        	            </c:forEach>
					</div>
				</div>
			</div>
			
							
			
		</div>
		<div class="movie_detail_box">
			<div class="detail_container">
				<div class="detail_img">
					<div class="detail_img_poster">
					    <c:choose>
			      		    <c:when test="${not empty movie.poster_path and movie.poster_path ne 'https://image.tmdb.org/t/p/w500null'}">
					            <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" alt="${movie.title}" />
					        </c:when>
					        <c:otherwise>
					            <img src="${pageContext.request.contextPath}/resources/IMG/default2.jpg" alt="포스터의 사진이 제공되지 않는 작품입니다." />
					        </c:otherwise>
					    </c:choose>											
					</div>
				</div>
				<div class="detail_info">
					 <h3>${movie.title }</h3>
					<div class="detail_overview">
						<p>${movie.overview}</p>
					</div>
				</div>
			</div>
				
		</div>
	
	<!--  여기부터 )-->
<div class="actor-info">
    <h2 class="actor-header">배우 정보</h2>

    <!-- 슬라이드 컨테이너 -->
    <div class="swiper">
        <div class="swiper-wrapper">
            <c:set var="count" value="0" />
            <c:forEach var="actor" items="${movie.casts}" varStatus="status">
                
                <!-- 12명씩 그룹으로 묶음 (새로운 슬라이드 시작) -->
                <c:if test="${status.index % 12 == 0}">
                    <div class="swiper-slide">
                        <div class="actor-grid">
                </c:if>

                <div class="actor-entry">
                    <a href="<c:url value='/actorDetail?id=${actor.id}'/>" class="actor-link">
                        <c:choose>
                            <c:when test="${not empty actor.profile_path and actor.profile_path ne 'https://image.tmdb.org/t/p/w500null'}">
                                <img src="${actor.profile_path}" alt="${actor.name}" class="actor-image"/>
                            </c:when>
                            <c:otherwise>
                                <img src="${pageContext.request.contextPath}/resources/IMG/default2.jpg" alt="사진이 제공되지 않는 인물입니다." class="actor-image"/>
                            </c:otherwise>
                        </c:choose>
                    </a>
                    <p class="actor-name">이름 : ${actor.name} (${actor.original_name})</p>
                    <p class="actor-gender">성별 : ${actor.gender == 1 ? '여성' : '남성'}</p>
                    <p class="actor-character">담당 배역 : ${actor.character}</p>
                </div>

                <!-- 12명 그룹의 끝 부분에서 div 태그 닫기 -->
                <c:if test="${status.index % 12 == 11 or status.last}">
                    </div> <!-- actor-grid 닫기 -->
                    </div> <!-- swiper-slide 닫기 -->
                </c:if>
            </c:forEach>
        </div>

        <!-- 네비게이션 버튼 -->
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>

        <!-- 페이지네이션 (점 표시) -->
        <div class="swiper-pagination"></div>
    </div>
</div>



			<!--  여기까지 추가함!!!! -->
	
	
	
	
	
	
		<div class="movie_url_box">
			<div class="url_img_container">
				<h2>갤러리</h2>
				<div class="url_img">
					<button class="carousel-button prev">&lt;</button>
    				<div class="carousel-container">
        				<c:forEach var="imageUrl" items="${movie.imageUrls}">
            				<div class="carousel-item">
                				<img src="${imageUrl}" alt="영화 이미지">
            				</div>
        				</c:forEach>
    				</div>
    				<button class="carousel-button next">&gt;</button>
				</div>			
			</div>
			
		
			<div class="url_video_box">
				<div class="url_video_container">
					<h2>동영상</h2>
					<div class="url_video">
						<button class="carousel2-button prev2">&lt;</button>
    					<div class="carousel2-container">
        					<c:forEach var="videoUrl" items="${movie.videoUrls}">
            					<div class="carousel2-item">
            						<a class="url_link" href="https://www.youtube.com/watch?v=${videoUrl }" target="blank">
                						<img class="thumbnail" src="https://img.youtube.com/vi/${videoUrl }/mqdefault.jpg" alt="영화 이미지">
                					</a>
            					</div>
        					</c:forEach>
    					</div>
    					<button class="carousel2-button next2">&gt;</button>
					</div>	
				</div>
			</div>
		</div>
		
		<div class="review_box">
			<div class="review_container">
				<div class="review_container_head">
					<h2 class = "page_title">영화 리뷰</h2>
					<div class="review_button">
    					<button class="reviewToggleButton" id="reviewToggleButton">더보기</button>
					</div>
				</div>
				
				
				<!-- 여기부터 -->
					<ul class="review_card">
					    <c:forEach var="review" items="${reviews}">
					        <li class="review_list" id="review_${review.ridx}">
					            <div class="review_comment">
					                <div class="review_info_top">
					                    <div class="review_info_title">${review.rtitle}</div>
					                    <div class="review_info_uidx">${review.uidx}</div>
					                </div> 
										<div class="review_info_rcontent">
										  	<a href="review?${review.ridx }" class="review_link">${review.rcontent}</a>
										</div>
					                <div class="review_info_mid">
					                    <div class="review_info_rgood">
					                        <button class="recommendButton"
					                                data-targetridx="${review.ridx}"
					                                data-type="1"
					                                data-movieid="${movie.id}"> <!-- movie.id 추가 -->
					                            <span class="material-symbols-outlined">thumb_up</span>
					                        </button>
					                        <div>${review.rgood}</div>
					                    </div>
					                    <div class="review_info_rreport">
					                        <button class="reportButton"
					                                data-targetridx="${review.ridx}"
					                                data-type="2"
					                                data-movieid="${movie.id}"> <!-- movie.id 추가 -->
					                            <span class="material-symbols-outlined">siren</span>
					                        </button>
					                        <div>${review.rreport}</div>
					                    </div>
					                </div>
					                <div class="review_info_rinsertdate">${review.rinsertdate}</div>
					            </div>
					        </li>
					    </c:forEach>
					</ul>

								
				<!-- 여기까지 수정됨 !! -->
				
			</div>
				
			<div class="comment_box">
				<div class="comment_container">
					<h2>리뷰 남기기</h2>
					<div class="form_box">
						<form action="/submitPost" method="post">
							<div class="review_title">
								<div class="review_rtitle">
				    				<label for="rtitle"></label>
				    				<%-- <label class="rtitle">${movie.title }</label> --%>
				    				<input class="r_input" type="text" id="rtitle" name="rtitle" value="${post.rtitle != null ? post.rtitle : ''}" placeholder="리뷰 제목을 적어주세요." required />
								</div>
								<div class="review_rname">
				    				<label for="uidx"></label>
				    				<label class="작성자">작성자</label>
				    				<input class="r_input" readonly type="text" id="uidx" name="uidx" value="${sessionScope.uname}" placeholder="로그인하셔야 리뷰를 작성할 수 있습니다." required />
								</div>	
							</div>
							
							<div class="review_content">
				    			<label for="rcontent"></label>
				    			<textarea id="r_content" name="rcontent" rows="4" cols="50" placeholder="이 ${movie.title }에 대한 생각을 자유롭게 표현해주세요!" required>${post.rcontent != null ? post.rcontent : ''}</textarea>
							</div>
							<input type="hidden" name="uidx" value="${sessionScope.uidx}" />
							<input type="hidden" name="mid" value="${movie.id }" />
				    		<button class="review_sbm_btn" type="submit">게시글 작성</button>
    					</form>
					</div>
    			</div>
    		</div>
		</div>
	</div>
	
	
	
	
	<div class="footlayout">
		<div class="foot_bar">
			<!-- <span>여기는 </span> -->
			<img class="logoimg" src="resources/IMG/moviepedia_22.png">
			<!-- <span> 입니다.</span> -->
		</div>
		<div class="foot_main">
			<ul class="foot_ulf">
				<li class="foot_li">서비스 이용약관</li>
				<li class="foot_li">개인정보 처리방침</li>
				<li class="foot_lif">회사 안내</li>
			</ul>
			<ul class="foot_ul">
				<li class="foot_li">고객센터</li>
				<li class="foot_lif">moviepeia@jj.ac.kr, +82-1577-7177</li>
			</ul>
			<ul class="foot_ul">
				<li class="foot_li">광고 문의</li>
				<li class="foot_lif">moviepeia@jj.ac.kr / 최신 광고 소개서</li>
			</ul>
			<ul class="foot_ul">
				<li class="foot_li">제휴 및 대외 협력</li>
				<li class="foot_lif">https://moviepedia.team/contact</li>
			</ul>
			<ul class="foot_ul">
				<li class="foot_li">무비피디아</li>
				<li class="foot_li">대표 구함</li>
				<li class="foot_lif">전북특별자치도 전주시 완산구 천잠로 303</li>
			</ul>
			<div class="copyright">
			<img class="foot_logo" src="resources/IMG/moviepedia_33.png">
			<span>© 2025 by MOVIEPEDIA, Inc. All rights reserved.</span>
			</div>
		</div>
	</div>
	
	<script>
	//로그인 modal is-show
	document.querySelector('.loginbtn').addEventListener(
			'click',
			function() {
				// 현재 버튼의 텍스트가 '로그아웃'인지 확인
				const isLogout = this.textContent.trim() === '로그아웃';

				if (isLogout) {
					// 로그아웃 상태면 로그아웃 처리
					window.location.href = '/logout';
				} else {
					// 로그인 상태가 아니면 모달창 표시
					document.querySelector('.modal.login').classList
							.add('is-show');
				}
			});

	// 기존 모달 관련 이벤트 리스너들은 유지
	document.querySelector('.modal .bg').addEventListener(
			'click',
			function() {
				document.querySelector('.modal.login').classList
						.remove('is-show');
			});

	document.querySelector('.modal.login .box a:nth-of-type(2)')
			.addEventListener(
					'click',
					function(event) {
						event.preventDefault();
						document.querySelector('.modal.login').classList
								.remove('is-show');
						document.querySelector('.modal.ID').classList
								.add('is-show');
					});

	document.querySelector('.modal.login .box a:nth-of-type(3)')
			.addEventListener(
					'click',
					function(event) {
						event.preventDefault();
						document.querySelector('.modal.login').classList
								.remove('is-show');
						document.querySelector('.modal.pw').classList
								.add('is-show');
					});

	document.querySelector('.modal.ID .bg').addEventListener(
			'click',
			function() {
				document.querySelector('.modal.ID').classList
						.remove('is-show');
			});

	document.querySelector('.modal.pw .bg').addEventListener(
			'click',
			function() {
				document.querySelector('.modal.pw').classList
						.remove('is-show');
			});
	
	//상단 메뉴바 투명설정
	const header = document.querySelector("#header");
      window.addEventListener("scroll", function () {
        if (window.scrollY > 75) {
          header.classList.add("on");
        } else {
          header.classList.remove("on");
        }
      });
     const img = document.querySelector("logoimg");
     	window.addEventListener("scroll", function (){
     		if(window.scrollY > 75){
     			document.getElementById("logoimg").src="resources/IMG/moviepedia_22.png";
     		}else {
     			document.getElementById("logoimg").src="resources/IMG/moviepedia_33.png";
     		}
     	});
     	
     	
// 리뷰 더보기 버튼 , 갤러리 넘기기 버튼 변수명 변경해야함 !01/24! 
     	
        document.getElementById('reviewToggleButton').addEventListener('click', function() {
   		const reviewLists = document.querySelectorAll('.review_list');
    	const isShowingAll = this.textContent === '숨기기';

    	if (isShowingAll) {
        	// 9번째부터 숨기기
        	reviewLists.forEach((review, index) => {
        	    if (index >= 8) {
        	        review.style.display = 'none';
        	    }
        	});
        	this.textContent = '더보기';
    	} else {
        // 모든 리뷰 보이게 하기
        reviewLists.forEach((review, index) => {
            if (index >= 8) {
                review.style.display = 'block';
            }
        	});
        this.textContent = '숨기기';
    		}
		});
     	
     	
     	document.addEventListener('DOMContentLoaded', function() {
     	    const container = document.querySelector('.carousel-container');
     	    const prevBtn = document.querySelector('.prev');
     	    const nextBtn = document.querySelector('.next');
     	    
     	    console.log("!23123");
     	    nextBtn.addEventListener('click', () => {
     	        container.scrollLeft += container.offsetWidth;
     	    });
     	    
     	    prevBtn.addEventListener('click', () => {
     	        container.scrollLeft -= container.offsetWidth;
     	    });
     	});
     	
     	document.addEventListener('DOMContentLoaded', function() {
     	    const container = document.querySelector('.carousel2-container');
     	    const prevBtn = document.querySelector('.prev2');
     	    const nextBtn = document.querySelector('.next2');
     	    
     	    nextBtn.addEventListener('click', () => {
     	        container.scrollLeft += container.offsetWidth;
     	    });
     	    
     	    prevBtn.addEventListener('click', () => {
     	        container.scrollLeft -= container.offsetWidth;
     	    });
     	});
     	
     	
     	
     	
     	
     	
     	
  	/* 	//추천, 신고 버튼 기능
        document.getElementById("recommendButton").onclick = function() {
        	console.log("추천버튼 Clicked(detail 243번째줄)")
            // 추천 기능 추가
        };

        document.getElementById("reportButton").onclick = function() {
            console.log("신고버튼 Clicked(detail 248번째줄)")
            // 신고 기능 추가
        }; */
   
     	
     	
     	
     	
        
        

     	
     
	</script>

<script>
$(document).ready(function() {
    // 추천/신고 공통 처리 함수
    function handleReaction(button, targetridx, type) {
        console.log(type + " 버튼 클릭됨");
        console.log("targetridx: " + targetridx);
        console.log("type: " + type);

        // movieId 값 가져오기
        var movieId = button.data("movieid");
        console.log("movieId: " + movieId); // movieId 확인

        // Ajax 요청
        $.ajax({
            url: "/recommend",   // 컨트롤러의 요청 URL
            type: "POST",
            data: {
                targetridx: targetridx,
                type: type,  // 1 또는 2로 전송
                movieId: movieId  // 영화 ID 추가
            },
            success: function(response) {
                console.log("AJAX 요청 성공");
                console.log("서버 응답: ", response);
                
                // 응답이 JSON 문자열이라면 파싱
                if (typeof response === "string") {
                    response = JSON.parse(response); // 응답을 JSON 객체로 파싱
                }

                // 이제 배열인지 확인
                if (Array.isArray(response)) {
                    updateReactionCounts(response);
                } else {
                    console.log("응답이 배열이 아닙니다.");
                    alert(response.message); 
                }
            },
            error: function(xhr, status, error) {
                console.log("AJAX 요청 실패");
                console.log("status: " + status);
                console.log("error: " + error);
                alert(response.message); 
            }
        });
    }

    // 추천/신고 수 갱신 함수
    function updateReactionCounts(reviews) {
        reviews.forEach(function(review) {
            // 해당 리뷰의 고유 ID로 DOM 요소 찾기
            var reviewElement = $("#review_" + review.ridx);  
            if (reviewElement.length > 0) {
                // 추천 수 갱신
                reviewElement.find(".recommendButton + div").text(review.rgood);
                // 신고 수 갱신
                reviewElement.find(".reportButton + div").text(review.rreport);
            }
        });
    }

    // 추천 버튼 클릭 시
    $(".recommendButton").click(function() {
        var targetridx = $(this).data("targetridx");
        var type = 1;  // 추천은 1로 고정

        // 현재 버튼을 참조
        var button = $(this);
        console.log("추천 버튼 클릭됨");
        handleReaction(button, targetridx, type);
    });

    // 신고 버튼 클릭 시
    $(".reportButton").click(function() {
        var targetridx = $(this).data("targetridx");
        var type = 2;  // 신고는 2로 고정

        // 현재 버튼을 참조
        var button = $(this);
        console.log("신고 버튼 클릭됨");
        handleReaction(button, targetridx, type);
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    new Swiper('.swiper', {
        slidesPerView: 1,   // 한 번에 하나의 그룹(4x3명)만 보이도록 설정
        spaceBetween: 20,   // 슬라이드 간격
        navigation: {       
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
        },
        pagination: {
            el: ".swiper-pagination",
            clickable: true,
        },
    });
});
</script>


</body>
</html>