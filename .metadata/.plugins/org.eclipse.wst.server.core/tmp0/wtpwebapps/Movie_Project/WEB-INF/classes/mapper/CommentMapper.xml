<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.kmove.app.mapper.CommentMapper">
    
    <select id="maxno" resultType="java.lang.Integer">
        SELECT
            IFNULL(MAX(SUBSTR(CIDX, 10, 3)), 0) + 1
        FROM COMMENT
        WHERE SUBSTR(CIDX, 2, 8) = DATE_FORMAT(NOW(), '%Y%m%d')
    </select>
    
<insert id="commitcomment" parameterType="CommentVo">
    INSERT INTO comment (
        CIDX,UIDX, RIDX, MID, CCOMMENT, CREPORT, 
        CDELETEYN, CINSERTDATE, CUPDATEDATE
    ) 
    VALUES (
        #{cidx}, #{uidx}, #{ridx}, #{mid}, 
        #{ccomment}, 0, 'N', NOW(), NOW()
    )
</insert>


<select id="IsitOk" resultType="int" parameterType="CommentVo">
SELECT 
    (EXISTS (SELECT 1 FROM review WHERE ridx = #{ridx})) +
    (EXISTS (SELECT 1 FROM user WHERE uidx = #{uidx})) 

</select>
<select id="selectcomments" parameterType="BlockUserVo" resultType="CommentVo">
    SELECT 
        c.CIDX, 
        u.UIDX,
        u.UNAME AS uidx,          <!-- 유저 이름 -->
        c.RIDX,
        c.CCOMMENT,                <!-- 댓글 내용 -->
        c.CINSERTDATE,             <!-- 댓글 작성일 -->
        c.CUPDATEDATE,             <!-- 댓글 수정일 -->
        r.RGOOD,                    <!-- 리뷰 공감 수 -->
        u.USAVEPROFILE AS usaveprofile
    FROM 
        comment c
    JOIN 
        Movie_Project.user u ON c.UIDX = u.UIDX  <!-- 댓글 작성자와 유저 정보 -->
    LEFT JOIN 
        BLOCKED b1 ON c.UIDX = b1.TARGET_UIDX AND b1.uidx = #{uidx} <!-- 차단된 경우 -->
    LEFT JOIN 
        BLOCKED b2 ON c.UIDX = b2.uidx AND b2.target_uidx = #{uidx} <!-- 차단된 경우 -->
    LEFT JOIN 
        review r ON c.RIDX = r.RIDX                 <!-- 댓글이 속한 리뷰 정보 -->
    WHERE 
        c.RIDX = #{targetUidx}                       <!-- 해당 리뷰의 댓글만 가져오기 -->
        AND r.RREPORT &lt; 5                     <!-- 신고가 5회 미만인 경우 -->
        AND b1.BIDX IS NULL AND b2.BIDX IS NULL      <!-- 차단되지 않은 댓글 -->
    ORDER BY 
        c.CINSERTDATE DESC,                         <!-- 작성일 최신순으로 정렬 -->
        r.RGOOD DESC;                               <!-- 공감 수가 많은 댓글부터 정렬 -->
</select>

    
    </mapper>
    